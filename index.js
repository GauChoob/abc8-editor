import fs from "fs";
import { ABC8, DefaultLGRPalette } from "elma-pcx";
import { createBMP } from "./bmp.js";

const MenuPalette = new Uint8Array([
  0x00, 0x94, 0xff, 0x9c, 0x39, 0x00, 0x4a, 0x5a, 0x00, 0x20, 0x08, 0x00, 0x9c,
  0x41, 0x00, 0x9c, 0x41, 0x08, 0xa4, 0x41, 0x00, 0x62, 0x73, 0x08, 0x31, 0x41,
  0x00, 0x52, 0x62, 0x00, 0x94, 0x41, 0x00, 0x5a, 0x6a, 0x08, 0x52, 0x5a, 0x00,
  0x41, 0x31, 0x00, 0x5a, 0x62, 0x00, 0x4a, 0x52, 0x00, 0x39, 0x4a, 0x00, 0x7b,
  0x39, 0x00, 0x73, 0x39, 0x08, 0x20, 0x31, 0x00, 0x4a, 0x5a, 0x08, 0x83, 0x39,
  0x00, 0x08, 0x31, 0x00, 0x52, 0x5a, 0x08, 0x39, 0x10, 0x00, 0x29, 0x41, 0x00,
  0x6a, 0x31, 0x00, 0x20, 0x41, 0x00, 0x31, 0x20, 0x00, 0x5a, 0x29, 0x00, 0x62,
  0x31, 0x00, 0x08, 0x10, 0x00, 0x39, 0x29, 0x00, 0x10, 0x31, 0x00, 0x94, 0x39,
  0x00, 0x94, 0x39, 0x08, 0x20, 0x39, 0x00, 0x94, 0x31, 0x00, 0x31, 0x18, 0x00,
  0x29, 0x31, 0x00, 0x8b, 0x39, 0x00, 0x4a, 0x31, 0x00, 0x20, 0x10, 0x00, 0xde,
  0xde, 0x08, 0x5a, 0x31, 0x00, 0x18, 0x41, 0x00, 0x4a, 0x29, 0x00, 0x20, 0x4a,
  0x00, 0x62, 0x20, 0x00, 0x52, 0x31, 0x00, 0x62, 0x20, 0x08, 0x7b, 0x29, 0x00,
  0x5a, 0x52, 0x00, 0x8b, 0x31, 0x00, 0x39, 0x52, 0x00, 0x39, 0x18, 0x00, 0x31,
  0x31, 0x00, 0x62, 0x5a, 0x00, 0x62, 0x5a, 0x08, 0x62, 0x00, 0x00, 0x41, 0x18,
  0x00, 0x08, 0x20, 0x00, 0x08, 0x18, 0x00, 0x18, 0x31, 0x00, 0x41, 0x29, 0x00,
  0x31, 0x10, 0x00, 0x62, 0x29, 0x00, 0x52, 0x4a, 0x00, 0x39, 0xa4, 0x29, 0x41,
  0x20, 0x00, 0x18, 0x29, 0x00, 0x5a, 0x20, 0x00, 0x41, 0x52, 0x00, 0x20, 0x18,
  0x00, 0x6a, 0x62, 0x00, 0x41, 0x4a, 0x00, 0x41, 0x39, 0x00, 0x41, 0x00, 0x00,
  0x73, 0x31, 0x00, 0x8b, 0x31, 0x08, 0x20, 0x20, 0x00, 0x5a, 0x29, 0x08, 0x18,
  0x10, 0x00, 0x29, 0x39, 0x00, 0x5a, 0x00, 0x00, 0x52, 0x20, 0x00, 0x73, 0x6a,
  0x00, 0x52, 0x18, 0x00, 0x73, 0x29, 0x00, 0x18, 0x18, 0x00, 0x20, 0x00, 0x00,
  0x29, 0x00, 0x00, 0x8b, 0x39, 0x08, 0x39, 0x31, 0x00, 0x5a, 0x20, 0x08, 0x31,
  0x4a, 0x00, 0x52, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x18, 0x00, 0x6a, 0x29,
  0x00, 0x41, 0x41, 0x00, 0x7b, 0x73, 0x00, 0x4a, 0x18, 0x00, 0x39, 0x00, 0x00,
  0x29, 0x29, 0x00, 0x73, 0x29, 0x08, 0x83, 0x31, 0x00, 0x10, 0x10, 0x00, 0x83,
  0x7b, 0x00, 0x52, 0x29, 0x00, 0x18, 0x39, 0x00, 0x18, 0x00, 0x00, 0x7b, 0x31,
  0x00, 0x83, 0x31, 0x08, 0x52, 0x52, 0x00, 0x29, 0x18, 0x00, 0x39, 0x41, 0x00,
  0x4a, 0x52, 0x08, 0x10, 0x39, 0x00, 0x08, 0x00, 0x00, 0x31, 0x00, 0x00, 0x39,
  0x20, 0x00, 0x52, 0x52, 0x08, 0x08, 0x29, 0x00, 0x7b, 0x7b, 0x00, 0x5a, 0x5a,
  0x00, 0x39, 0x39, 0x00, 0x8b, 0x83, 0x00, 0x20, 0x29, 0x00, 0x6a, 0x6a, 0x00,
  0x52, 0x20, 0x08, 0xd5, 0xd5, 0x08, 0x94, 0x8b, 0x00, 0xe6, 0xe6, 0x08, 0x62,
  0x62, 0x00, 0x5a, 0x62, 0x08, 0xac, 0xa4, 0x00, 0x4a, 0x4a, 0x00, 0x5a, 0x52,
  0x08, 0x83, 0x83, 0x00, 0x73, 0x00, 0x00, 0x62, 0x62, 0x08, 0x73, 0x31, 0x08,
  0x41, 0x10, 0x00, 0xa4, 0x9c, 0x00, 0x9c, 0x94, 0x00, 0x7b, 0x31, 0x08, 0xe6,
  0xde, 0x08, 0x18, 0x20, 0x00, 0x73, 0x73, 0x00, 0x73, 0x73, 0x08, 0x83, 0x39,
  0x08, 0x6a, 0x29, 0x08, 0x6a, 0x73, 0x08, 0x10, 0x08, 0x00, 0x5a, 0x5a, 0x08,
  0x6a, 0x6a, 0x08, 0x7b, 0x73, 0x08, 0x8b, 0x8b, 0x00, 0xcd, 0xcd, 0x08, 0x29,
  0x10, 0x00, 0x6a, 0x00, 0x00, 0x31, 0x39, 0x00, 0x6a, 0x62, 0x08, 0x10, 0x29,
  0x00, 0x52, 0x4a, 0x08, 0x62, 0x29, 0x08, 0x4a, 0x00, 0x00, 0x08, 0x08, 0x00,
  0xcd, 0x00, 0x00, 0xde, 0xd5, 0x08, 0x10, 0x20, 0x00, 0x7b, 0x39, 0x08, 0xde,
  0x00, 0x00, 0x41, 0x5a, 0x00, 0x8b, 0x8b, 0x08, 0xc5, 0xc5, 0x00, 0x7b, 0x00,
  0x00, 0x73, 0x7b, 0x08, 0x94, 0x94, 0x00, 0xee, 0xee, 0x20, 0x62, 0x6a, 0x08,
  0xc5, 0xc5, 0x08, 0x9c, 0x9c, 0x00, 0x7b, 0x9c, 0xde, 0x4a, 0x41, 0x00, 0xee,
  0x00, 0x00, 0x8b, 0x83, 0x08, 0x8b, 0x00, 0x00, 0x31, 0x29, 0x00, 0xd5, 0xcd,
  0x08, 0xbd, 0xbd, 0x00, 0x9c, 0x94, 0x08, 0x6a, 0x31, 0x08, 0xa4, 0xa4, 0x00,
  0xa4, 0x4a, 0x00, 0xc5, 0x00, 0x00, 0x29, 0x08, 0x00, 0xbd, 0xbd, 0x08, 0x83,
  0x83, 0x08, 0x83, 0x00, 0x00, 0x4a, 0x20, 0x00, 0xac, 0xac, 0x00, 0xb4, 0xb4,
  0x00, 0x00, 0x4a, 0x00, 0x9c, 0x00, 0x00, 0x83, 0x7b, 0x08, 0xbd, 0xb4, 0x08,
  0xac, 0xac, 0x08, 0xe6, 0x00, 0x00, 0xb4, 0x00, 0x00, 0xcd, 0xc5, 0x08, 0xac,
  0xa4, 0x08, 0x94, 0x94, 0x08, 0x52, 0x62, 0x08, 0xf6, 0xf6, 0x20, 0x7b, 0x7b,
  0x08, 0xac, 0x00, 0x00, 0x29, 0x20, 0x00, 0x94, 0x00, 0x00, 0xb4, 0xb4, 0x08,
  0xd5, 0x00, 0x00, 0xa4, 0xa4, 0x08, 0xa4, 0x9c, 0x08, 0x00, 0x41, 0x00, 0xe6,
  0xe6, 0x20, 0x73, 0x6a, 0x08, 0x00, 0x41, 0x08, 0x6a, 0x20, 0x00, 0xbd, 0x00,
  0x00, 0x9c, 0x9c, 0x08, 0xc5, 0xbd, 0x08, 0x00, 0x4a, 0x08, 0x00, 0x00, 0x00,
  0xa4, 0x00, 0x00, 0xb4, 0xac, 0x08, 0x00, 0x39, 0x00, 0xff, 0x00, 0x00, 0x00,
  0x08, 0x00, 0xf6, 0x00, 0x00, 0x00, 0x31, 0x00, 0x8b, 0x41, 0x08, 0x00, 0x29,
  0x00, 0x00, 0x29, 0x08, 0x00, 0x31, 0x08, 0x00, 0x39, 0x08, 0x94, 0x8b, 0x08,
  0x00, 0x18, 0x00, 0x00, 0x10, 0x00, 0x9c, 0x39, 0x08, 0x00, 0x20, 0x00, 0x83,
  0x29, 0x00, 0xff, 0x08, 0x08, 0xff, 0xff, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00,
]);

const EditorPalette = new Uint8Array([
  0x00, 0x00, 0x00, 0x78, 0x80, 0xb4, 0x30, 0x38, 0x68, 0xa8, 0x90, 0x8c, 0xfc,
  0xd8, 0xd4, 0x00, 0x00, 0x00, 0xd4, 0x94, 0x88, 0xdc, 0xd0, 0xcc, 0xc4, 0xc8,
  0xe4, 0xfc, 0xfc, 0xfc, 0xb4, 0x78, 0x6c, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0xfc, 0xfc, 0xfc, 0x80, 0x80, 0x80, 0x08, 0x08, 0x08,
  0x08, 0x08, 0x48, 0x08, 0x08, 0x88, 0x08, 0x08, 0xc8, 0x08, 0x48, 0x08, 0x08,
  0x48, 0x48, 0x08, 0x48, 0x88, 0x08, 0x48, 0xc8, 0x08, 0x88, 0x08, 0x08, 0x88,
  0x48, 0x08, 0x88, 0x88, 0x08, 0x88, 0xc8, 0x08, 0xc8, 0x08, 0x08, 0xc8, 0x48,
  0x08, 0xc8, 0x88, 0x08, 0xc8, 0xc8, 0x48, 0x08, 0x08, 0x48, 0x08, 0x48, 0x48,
  0x08, 0x88, 0x48, 0x08, 0xc8, 0x48, 0x48, 0x08, 0x48, 0x48, 0x48, 0x48, 0x48,
  0x88, 0x48, 0x48, 0xc8, 0x48, 0x88, 0x08, 0x48, 0x88, 0x48, 0x48, 0x88, 0x88,
  0x48, 0x88, 0xc8, 0x48, 0xc8, 0x08, 0x48, 0xc8, 0x48, 0x48, 0xc8, 0x88, 0x48,
  0xc8, 0xc8, 0x88, 0x08, 0x08, 0x88, 0x08, 0x48, 0x88, 0x08, 0x88, 0x88, 0x08,
  0xc8, 0x88, 0x48, 0x08, 0x88, 0x48, 0x48, 0x88, 0x48, 0x88, 0x88, 0x48, 0xc8,
  0x88, 0x88, 0x08, 0x88, 0x88, 0x48, 0x88, 0x88, 0x88, 0x88, 0x88, 0xc8, 0x88,
  0xc8, 0x08, 0x88, 0xc8, 0x48, 0x88, 0xc8, 0x88, 0x88, 0xc8, 0xc8, 0xc8, 0x08,
  0x08, 0xc8, 0x08, 0x48, 0xc8, 0x08, 0x88, 0xc8, 0x08, 0xc8, 0xc8, 0x48, 0x08,
  0xc8, 0x48, 0x48, 0xc8, 0x48, 0x88, 0xc8, 0x48, 0xc8, 0xc8, 0x88, 0x08, 0xc8,
  0x88, 0x48, 0xc8, 0x88, 0x88, 0xc8, 0x88, 0xc8, 0xc8, 0xc8, 0x08, 0xc8, 0xc8,
  0x48, 0xc8, 0xc8, 0x88, 0xc8, 0xc8, 0xc8, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00,
  0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  0xfc, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00,
]);

const getSpacing = (filename) => {
  if (filename == "menu") {
    return 2;
  }
  return 1;
};

const getPalette = (filename) => {
  if (filename == "menu") {
    return MenuPalette;
  }
  if (filename.startsWith("kisbetu")) {
    return EditorPalette;
  }
  return DefaultLGRPalette;
};

const isFlipped = (filename) => {
  if (filename == "menu") {
    return 0;
  }
  if (filename.startsWith("kisbetu")) {
    return 0;
  }
  if (filename == "small") {
    return 17;
  }
  if (filename == "medium") {
    return 24;
  }
  if (filename == "large") {
    return 91;
  }
};

const verticalFlip = (sprite) => {
  const temp = new Uint8Array(sprite.width);
  for (let i = 0; i < Math.floor(sprite.height / 2); i++) {
    const top = i * sprite.width;
    const bottom = (sprite.height - 1 - i) * sprite.width;
    temp.set(sprite.pixels.subarray(top, top + sprite.width));
    sprite.pixels.copyWithin(top, bottom, bottom + sprite.width);
    sprite.pixels.set(temp, bottom);
  }
};

const getTransparencyIndex = (filename) => {
  if (filename == "menu") {
    return 0;
  }
  if (filename.startsWith("kisbetu")) {
    return 115;
  }
  return 145;
};

const addTransparency = (sprite, index) => {
  for (let i = 0; i < sprite.width * sprite.height; i++) {
    if (sprite.transparency[i] == false) {
      sprite.pixels[i] = index;
    }
  }
};

function getAtlas(abc, filename) {
  let totalWidth = 0;
  let maxHeight = 0;
  let minHeight = 100000000;
  const spacing = getSpacing(filename);

  for (const letter of abc.letters) {
    totalWidth += letter.sprite.width + spacing;
    minHeight = Math.min(minHeight, letter.y);
    maxHeight = Math.max(maxHeight, letter.sprite.height + letter.y);
  }

  const height = maxHeight - minHeight;

  const atlasPixels = new Uint8Array(totalWidth * height);
  atlasPixels.fill(getTransparencyIndex(filename));

  let x = 0;

  for (const letter of abc.letters) {
    const sprite = letter.sprite;
    const dstY = letter.y - minHeight;
    for (let y = 0; y < sprite.height; y++) {
      const srcRowStart = y * sprite.width;
      const dstRowStart = (dstY + y) * totalWidth + x;
      atlasPixels.set(
        sprite.pixels.subarray(srcRowStart, srcRowStart + sprite.width),
        dstRowStart,
      );
    }

    x += sprite.width + spacing;
  }

  const sprite = {
    width: totalWidth,
    height: height,
    pixels: atlasPixels,
  };

  const data = createBMP(sprite, getPalette(filename));
  fs.writeFileSync(`./fonts/${filename}/Atlas.bmp`, data);
}

const getAbc = async (filename) => {
  if (!fs.existsSync(`./fonts/${filename}/`)) {
    fs.mkdirSync(`./fonts/${filename}/`);
  }
  const file = fs.readFileSync(`./fonts/${filename}.abc`);
  const abc = ABC8.fromBuffer(file);
  const flipped = isFlipped(filename);
  const palette = getPalette(filename);
  const transparency = getTransparencyIndex(filename);
  for (let i = 0; i < abc.letters.length; i++) {
    const letter = abc.letters[i];
    const sprite = letter.sprite;
    addTransparency(sprite, transparency);
    if (flipped) {
      letter.y = flipped - sprite.height - letter.y;
      verticalFlip(sprite);
    }
    const data = createBMP(sprite, palette);
    fs.writeFileSync(
      `./fonts/${filename}/${letter.code}_${letter.y}.bmp`,
      data,
    );
  }

  getAtlas(abc, filename);
};

getAbc("small");
getAbc("medium");
getAbc("large");
getAbc("kisbetu1");
getAbc("kisbetu2");
getAbc("menu");
